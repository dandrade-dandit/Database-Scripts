--POUSO, DECOLAGEM E MOVIMENTAÇÃO NA MESMA LINHA
--

DECLARE  @SIGLA_AEROPORTO VARCHAR(4)
,			@ANO INT
,			@MES INT
,			@DIA INT


SET @SIGLA_AEROPORTO = 'SBGR'
SET	@ANO = 2009
SET @MES = 7
SET @DIA = 1

SET NOCOUNT ON

DECLARE @TMP TABLE (      
       CD_STA INT
	  ,SIGLA_AEROPORTO VARCHAR(4)
      ,NUMERO_VOO INT 
      ,GRUPO_VOO INT
      ,NATUREZA_VOO INT
      ,CLASSE_VOO INT
      ,CATEGORIA_VOO INT
      ,CATEGORIA_VOO_VINCULADO INT
      ,TIPO_MOV_PO VARCHAR(4)
      ,DATA_HORA_PROGRAMADA_POUSO DATETIME
      ,DATA_HORA_EFETIVA_POUSO DATETIME
      ,SIGLA_CIA_AEREA_IATA_CHEGADA VARCHAR(10) 
      ,NME_CIA_AEREA_CHEGADA VARCHAR(40)
      ,MATRICULA_AERONAVE_CHEGADA VARCHAR(10)
      ,SIGLA_EQUIPAMENTO_CHEGADA VARCHAR(10)
      ,NME_EQUIPAMENTO_CHEGADA VARCHAR(40)
      ,SIGLA_AEROPORTO_PRO VARCHAR(4)
      ,PISTA_POUSO VARCHAR(4)
      ,TIPO_MOV_EP VARCHAR(4)
      ,DATA_HORA_MOV_EP DATETIME
      ,BOX_EP VARCHAR(4)
      ,TIPO_BOX_EP VARCHAR(4)
      ,TPS_EP VARCHAR(4)
      ,TIPO_MOV_SP VARCHAR(4)
      ,DATA_HORA_MOV_SP DATETIME
      ,TIPO_MOV_DE VARCHAR(4)
      ,DATA_HORA_PROGRAMADA_DECOLAGEM DATETIME
      ,DATA_HORA_EFETIVA_DECOLAGEM DATETIME
      ,SIGLA_CIA_AEREA_IATA_PARTIDA VARCHAR(10)
      ,NME_CIA_AEREA_PARTIDA VARCHAR(40)
      ,MATRICULA_AERONAVE_PARTIDA VARCHAR(10)
      ,SIGLA_EQUIPAMENTO_PARTIDA VARCHAR(10)
      ,NME_EQUIPAMENTO_PARTIDA VARCHAR(40)
      ,SIGLA_AEROPORTO_DES VARCHAR(4)
      ,PISTA_DECOLAGEM VARCHAR(4)
)

INSERT INTO @TMP
SELECT D.CD_STA
      ,D.SIGLA_AEROPORTO
      ,D.NUMERO_VOO
      ,D.GRUPO_VOO
      ,D.NATUREZA_VOO
      ,D.CLASSE_VOO
      ,D.CATEGORIA_VOO
      ,D.CATEGORIA_VOO_VINCULADO
      ,'PO' AS TIPO_MOV_PO
      ,D.DATA_HORA_NORMAL_POUSO
      ,D.DATA_HORA_EFETIVA_POUSO
      ,D.SIGLA_IATA_CIA_AEREA AS SIGLA_CIA_AEREA_IATA_CHEGADA
      ,D.NME_CIA_AEREA AS NME_CIA_AEREA_CHEGADA
      ,D.MATRICULA_AERONAVE AS MATRICULA_AERONAVE_CHEGADA    
      ,D.SIGLA_EQUIPAMENTO AS SIGLA_EQUIPAMENTO_CHEGADA
      ,D.NME_EQUIPAMENTO AS NME_EQUIPAMENTO_CHEGADA
      ,D.SIGLA_AEROPORTO_PRO
      ,D.DSC_PISTA_POU AS PISTA_POUSO
      ,NULL AS TIPO_MOV_EP
      ,NULL AS DATA_HORA_MOV_EP
      ,NULL AS BOX_EP
      ,NULL AS TIPO_BOX_EP
      ,NULL AS TPS_EP
      ,NULL AS TIPO_MOV_SP
      ,NULL AS DATA_HORA_MOV_SP
      ,'DE' AS TIPO_MOV_DE
      ,E.DATA_HORA_NORMAL_DECOLAGEM
      ,E.DATA_HORA_EFETIVA_DECOLAGEM
      ,E.SIGLA_IATA_CIA_AEREA AS SIGLA_CIA_AEREA_IATA_PARTIDA
      ,E.NME_CIA_AEREA AS NME_CIA_AEREA_PARTIDA
      ,E.MATRICULA_AERONAVE AS MATRICULA_AERONAVE_PARTIDA    
      ,E.SIGLA_EQUIPAMENTO AS SIGLA_EQUIPAMENTO_PARTIDA
      ,E.NME_EQUIPAMENTO AS NME_EQUIPAMENTO_PARTIDA
      ,E.SIGLA_AEROPORTO_DES
      ,E.DSC_PISTA_DEC AS PISTA_DECOLAGEM
  FROM  BIOGER_RPE_DES AS D
     ,  BIOGER_RPE_EMB AS E
 WHERE  D.CD_STA = E.CD_STA
   AND  D.SIGLA_AEROPORTO = E.SIGLA_AEROPORTO
   AND  D.SIGLA_AEROPORTO = @SIGLA_AEROPORTO
   AND  YEAR(D.DATA_HORA_EFETIVA_POUSO) = @ANO
   AND	MONTH(D.DATA_HORA_EFETIVA_POUSO) = @MES
   --AND  DAY(D.DATA_HORA_EFETIVA_POUSO) = @DIA
   AND  D.GRUPO_VOO = 1
			

DECLARE
		@STA INT
       ,@AEROPORTO VARCHAR(4)
       ,@TIPO_MOV VARCHAR(4)
       ,@DATA_HORA_MOV DATETIME
       ,@NR_BOX VARCHAR(4)
       ,@TP_BOX VARCHAR(4)
       ,@NR_TPS VARCHAR(4)

DECLARE C_MOV CURSOR FOR
SELECT 	DISTINCT
        CD_STA
       ,SIGLA_AEROPORTO
FROM   @TMP

OPEN C_MOV
FETCH NEXT FROM C_MOV 
INTO @STA
,    @AEROPORTO


WHILE @@FETCH_STATUS = 0
BEGIN

        DECLARE C_MOV_EP CURSOR FOR
		SELECT TIPO_MOV
			  ,DATA_HORA_MOV
			  ,NR_BOX
			  ,TP_BOX
			  ,NR_TPS
        FROM  BIOGER_RPE_MOV
        WHERE CD_STA = @STA
          AND SIGLA_AEROPORTO = @AEROPORTO
          AND TIPO_MOV = 'EP'
        ORDER BY DATA_HORA_MOV

	    OPEN C_MOV_EP
		FETCH NEXT FROM C_MOV_EP 
		INTO   @TIPO_MOV
			  ,@DATA_HORA_MOV
			  ,@NR_BOX
			  ,@TP_BOX
			  ,@NR_TPS
   
        WHILE @@FETCH_STATUS = 0
        BEGIN

			UPDATE @TMP
			SET    TIPO_MOV_EP = @TIPO_MOV
				  ,DATA_HORA_MOV_EP = @DATA_HORA_MOV
				  ,BOX_EP = @NR_BOX
				  ,TIPO_BOX_EP = @TP_BOX
				  ,TPS_EP = @NR_TPS
           WHERE CD_STA = @STA
             AND SIGLA_AEROPORTO = @AEROPORTO

           BREAK 

        END

		CLOSE C_MOV_EP
		DEALLOCATE C_MOV_EP


		DECLARE C_MOV_SP CURSOR FOR
		SELECT TIPO_MOV
			  ,DATA_HORA_MOV
        FROM  BIOGER_RPE_MOV
        WHERE CD_STA = @STA
          AND SIGLA_AEROPORTO = @AEROPORTO
          AND TIPO_MOV = 'SP'
        ORDER BY DATA_HORA_MOV DESC

	    OPEN C_MOV_SP
		FETCH NEXT FROM C_MOV_SP 
		INTO   @TIPO_MOV
			  ,@DATA_HORA_MOV

   
        WHILE @@FETCH_STATUS = 0
        BEGIN

			UPDATE @TMP
			SET    TIPO_MOV_SP = @TIPO_MOV
				  ,DATA_HORA_MOV_SP = @DATA_HORA_MOV
           WHERE CD_STA = @STA
             AND SIGLA_AEROPORTO = @AEROPORTO

           BREAK 

        END

		CLOSE C_MOV_SP
		DEALLOCATE C_MOV_SP

		FETCH NEXT FROM C_MOV 
		INTO @STA
		,    @AEROPORTO

END

CLOSE C_MOV
DEALLOCATE C_MOV

SELECT *
FROM @TMP
 ORDER
    BY  DATA_HORA_EFETIVA_POUSO, NUMERO_VOO
      


--
--POUSO E ENTRADA DE PÁTIO NUMA LINHA E DECOLAGEM E SAÍDA DE PÁTIO NA OUTRA
--




DECLARE  @SIGLA_AEROPORTO VARCHAR(4)
,			@ANO INT
,			@MES INT
,			@DIA INT


SET @SIGLA_AEROPORTO = 'SBFI'
SET	@ANO = 2005
SET @MES = 7
SET @DIA = 1

SET NOCOUNT ON
    
DECLARE @TMP TABLE (
       CD_STA INT
	  ,SIGLA_AEROPORTO VARCHAR(4)
      ,NUMERO_VOO INT 
      ,GRUPO_VOO INT
      ,NATUREZA_VOO INT
      ,CLASSE_VOO INT
      ,CATEGORIA_VOO INT
      ,TIPO_MOV_POU_DEC VARCHAR(4)
      ,DATA_HORA_PROGRAMADA_POU_DEC DATETIME
      ,DATA_HORA_EFETIVA_POU_DEC DATETIME
      ,SIGLA_CIA_AEREA_IATA_CHG_PAR VARCHAR(20) 
      ,NME_CIA_AEREA_CHG_PAR VARCHAR(40)
      ,MATRICULA_AERONAVE_CHG_PAR VARCHAR(10)
      ,SIGLA_EQUIPAMENTO_CHG_PAR VARCHAR(10)
      ,NME_EQUIPAMENTO_CHG_PAR VARCHAR(40)
      ,SIGLA_AEROPORTO_PRO_DES VARCHAR(4)
      ,PISTA_POU_DEC VARCHAR(12)
      ,TIPO_MOV_EP_SP VARCHAR(4)
      ,DATA_HORA_MOV_EP_SP DATETIME
      ,BOX_EP VARCHAR(4)
      ,TIPO_BOX_EP VARCHAR(4)
      ,TPS_EP VARCHAR(4)
      ,ORDEM INT
)


INSERT INTO @TMP
SELECT DISTINCT 
	   D.CD_STA
      ,D.SIGLA_AEROPORTO
      ,D.NUMERO_VOO
      ,D.GRUPO_VOO
      ,D.NATUREZA_VOO
      ,D.CLASSE_VOO
      ,D.CATEGORIA_VOO
      ,'PO' AS TIPO_MOV_PO
      ,D.DATA_HORA_NORMAL_POUSO
      ,D.DATA_HORA_EFETIVA_POUSO
      ,D.SIGLA_IATA_CIA_AEREA AS SIGLA_CIA_AEREA_IATA_CHEGADA
      ,D.NME_CIA_AEREA AS NME_CIA_AEREA_CHEGADA
      ,D.MATRICULA_AERONAVE AS MATRICULA_AERONAVE_CHEGADA    
      ,D.SIGLA_EQUIPAMENTO AS SIGLA_EQUIPAMENTO_CHEGADA
      ,D.NME_EQUIPAMENTO AS NME_EQUIPAMENTO_CHEGADA
      ,D.SIGLA_AEROPORTO_PRO
      ,D.DSC_PISTA_POU AS PISTA_POUSO
      ,(SELECT TOP 1 TIPO_MOV FROM BIOGER_RPE_MOV WHERE CD_STA = D.CD_STA AND SIGLA_AEROPORTO = D.SIGLA_AEROPORTO AND TIPO_MOV = 'EP' ORDER BY DATA_HORA_MOV) AS TIPO_MOV_EP
      ,(SELECT TOP 1 DATA_HORA_MOV FROM BIOGER_RPE_MOV WHERE CD_STA = D.CD_STA AND SIGLA_AEROPORTO = D.SIGLA_AEROPORTO AND TIPO_MOV = 'EP' ORDER BY DATA_HORA_MOV) AS DATA_HORA_MOV_EP
      ,(SELECT TOP 1 NR_BOX FROM BIOGER_RPE_MOV WHERE CD_STA = D.CD_STA AND SIGLA_AEROPORTO = D.SIGLA_AEROPORTO AND TIPO_MOV = 'EP' ORDER BY DATA_HORA_MOV) AS BOX_EP
      ,(SELECT TOP 1 TP_BOX FROM BIOGER_RPE_MOV WHERE CD_STA = D.CD_STA AND SIGLA_AEROPORTO = D.SIGLA_AEROPORTO AND TIPO_MOV = 'EP' ORDER BY DATA_HORA_MOV) AS TIPO_BOX_EP
      ,(SELECT TOP 1 NR_TPS FROM BIOGER_RPE_MOV WHERE CD_STA = D.CD_STA AND SIGLA_AEROPORTO = D.SIGLA_AEROPORTO AND TIPO_MOV = 'EP' ORDER BY DATA_HORA_MOV) AS TPS_EP
      ,1 AS ORDEM
  FROM  BIOGER_RPE_DES AS D
     ,  BIOGER_RPE_EMB AS E
 WHERE  D.CD_STA = E.CD_STA
   AND  D.SIGLA_AEROPORTO = E.SIGLA_AEROPORTO
   AND  D.SIGLA_AEROPORTO = @SIGLA_AEROPORTO
   AND  YEAR(D.DATA_HORA_EFETIVA_POUSO) >= @ANO
--   AND	MONTH(D.DATA_HORA_EFETIVA_POUSO) = @MES
--   AND  DAY(D.DATA_HORA_EFETIVA_POUSO) = @DIA
   AND  D.GRUPO_VOO = 1


INSERT INTO @TMP
SELECT DISTINCT 
	   D.CD_STA
      ,D.SIGLA_AEROPORTO
      ,D.NUMERO_VOO
      ,D.GRUPO_VOO
      ,D.NATUREZA_VOO
      ,D.CLASSE_VOO
      ,D.CATEGORIA_VOO
      ,'DE' AS TIPO_MOV_DE
      ,E.DATA_HORA_NORMAL_DECOLAGEM
      ,E.DATA_HORA_EFETIVA_DECOLAGEM
      ,E.SIGLA_IATA_CIA_AEREA AS SIGLA_CIA_AEREA_IATA_PARTIDA
      ,E.NME_CIA_AEREA AS NME_CIA_AEREA_PARTIDA
      ,E.MATRICULA_AERONAVE AS MATRICULA_AERONAVE_PARTIDA    
      ,E.SIGLA_EQUIPAMENTO AS SIGLA_EQUIPAMENTO_PARTIDA
      ,E.NME_EQUIPAMENTO AS NME_EQUIPAMENTO_PARTIDA
      ,E.SIGLA_AEROPORTO_DES
      ,E.DSC_PISTA_DEC AS PISTA_DECOLAGEM
      ,(SELECT TOP 1 TIPO_MOV FROM  BIOGER_RPE_MOV WHERE CD_STA = E.CD_STA AND SIGLA_AEROPORTO = E.SIGLA_AEROPORTO AND TIPO_MOV = 'SP' ORDER BY DATA_HORA_MOV DESC) AS TIPO_MOV_EP
      ,(SELECT TOP 1 DATA_HORA_MOV FROM  BIOGER_RPE_MOV WHERE CD_STA = E.CD_STA AND SIGLA_AEROPORTO = E.SIGLA_AEROPORTO AND TIPO_MOV = 'SP' ORDER BY DATA_HORA_MOV DESC) AS DATA_HORA_MOV_EP
      ,NULL AS BOX_EP
      ,NULL AS TIPO_BOX_EP
      ,NULL AS TPS_EP
      ,2 AS ORDEM
  FROM  BIOGER_RPE_DES AS D
     ,  BIOGER_RPE_EMB AS E
 WHERE  D.CD_STA = E.CD_STA
   AND  D.SIGLA_AEROPORTO = E.SIGLA_AEROPORTO
   AND  D.SIGLA_AEROPORTO = @SIGLA_AEROPORTO
   AND	YEAR(D.DATA_HORA_EFETIVA_POUSO) >= @ANO
 --  AND	MONTH(D.DATA_HORA_EFETIVA_POUSO) = @MES
 --  AND  DAY(D.DATA_HORA_EFETIVA_POUSO) = @DIA
   AND  D.GRUPO_VOO = 1
   AND  D.CATEGORIA_VOO_VINCULADO IS NULL

--
INSERT INTO INTEGRACAO..BIOGER_TCU
SELECT *
FROM @TMP
 ORDER
    BY  CD_STA, ORDEM --NUMERO_VOO, ORDEM


--TRUNCATE TABLE INTEGRACAO.dbo.BIOGER_TCU


/*

SELECT TOP 1 TIPO_MOV
	  ,DATA_HORA_MOV
FROM  BIOGER_RPE_MOV
WHERE CD_STA = 10053
  AND SIGLA_AEROPORTO = 'SBBE'
  AND TIPO_MOV = 'SP'
ORDER BY DATA_HORA_MOV DESC


*/



--
--CADAS INFORMAÇÃO EM UMA LINHA
--

DECLARE  @SIGLA_AEROPORTO VARCHAR(4)
,			@ANO INT
,			@MES INT
,			@DIA INT


SET @SIGLA_AEROPORTO = 'SBGR'
SET	@ANO = 2009
SET @MES = 7
SET @DIA = 1

SET NOCOUNT ON

DECLARE @TMP TABLE (      
       CD_STA INT
	  ,SIGLA_AEROPORTO VARCHAR(4)
      ,NUMERO_VOO INT 
      ,GRUPO_VOO INT
      ,NATUREZA_VOO INT
      ,CLASSE_VOO INT
      ,CATEGORIA_VOO INT
      ,CATEGORIA_VOO_VINCULADO INT
      ,TIPO_MOV VARCHAR(4)
      ,DATA_HORA_PROGRAMADA_POU_DEC DATETIME
      ,DATA_HORA_EFETIVA_POU_DEC DATETIME
      ,SIGLA_CIA_AEREA_IATA_CHG_PAR VARCHAR(10) 
      ,NME_CIA_AEREA_CHG_PAR VARCHAR(40)
      ,MATRICULA_AERONAVE_CHG_PAR VARCHAR(10)
      ,SIGLA_EQUIPAMENTO_CHG_PAR VARCHAR(10)
      ,NME_EQUIPAMENTO_CHG_PAR VARCHAR(40)
      ,SIGLA_AEROPORTO_PRO_DES VARCHAR(4)
      ,PISTA_POU_DEC VARCHAR(4)
      ,DATA_HORA_MOV_EP_SP DATETIME
      ,BOX_EP VARCHAR(4)
      ,TIPO_BOX_EP VARCHAR(4)
      ,TPS_EP VARCHAR(4)
      ,ORDEM INT
)

INSERT INTO @TMP
SELECT D.CD_STA
      ,D.SIGLA_AEROPORTO
      ,D.NUMERO_VOO
      ,D.GRUPO_VOO
      ,D.NATUREZA_VOO
      ,D.CLASSE_VOO
      ,D.CATEGORIA_VOO
      ,D.CATEGORIA_VOO_VINCULADO
      ,'PO' AS TIPO_MOV_PO
      ,D.DATA_HORA_NORMAL_POUSO
      ,D.DATA_HORA_EFETIVA_POUSO
      ,D.SIGLA_IATA_CIA_AEREA AS SIGLA_CIA_AEREA_IATA_CHEGADA
      ,D.NME_CIA_AEREA AS NME_CIA_AEREA_CHEGADA
      ,D.MATRICULA_AERONAVE AS MATRICULA_AERONAVE_CHEGADA    
      ,D.SIGLA_EQUIPAMENTO AS SIGLA_EQUIPAMENTO_CHEGADA
      ,D.NME_EQUIPAMENTO AS NME_EQUIPAMENTO_CHEGADA
      ,D.SIGLA_AEROPORTO_PRO
      ,D.DSC_PISTA_POU AS PISTA_POUSO
      ,NULL AS DATA_HORA_MOV_EP
      ,NULL AS BOX_EP
      ,NULL AS TIPO_BOX_EP
      ,NULL AS TPS_EP
      ,1 AS ORDEM
  FROM  BIOGER_RPE_DES AS D
     ,  BIOGER_RPE_EMB AS E
 WHERE  D.CD_STA = E.CD_STA
   AND  D.SIGLA_AEROPORTO = E.SIGLA_AEROPORTO
   AND  D.SIGLA_AEROPORTO = @SIGLA_AEROPORTO
   AND  YEAR(D.DATA_HORA_EFETIVA_POUSO) = @ANO
   AND	MONTH(D.DATA_HORA_EFETIVA_POUSO) = @MES
   --AND  DAY(D.DATA_HORA_EFETIVA_POUSO) = @DIA
   AND  D.GRUPO_VOO = 1

INSERT INTO @TMP
SELECT D.CD_STA
      ,D.SIGLA_AEROPORTO
      ,D.NUMERO_VOO
      ,D.GRUPO_VOO
      ,D.NATUREZA_VOO
      ,D.CLASSE_VOO
      ,D.CATEGORIA_VOO
      ,D.CATEGORIA_VOO_VINCULADO
      ,'DE' AS TIPO_MOV_DE
      ,E.DATA_HORA_NORMAL_DECOLAGEM
      ,E.DATA_HORA_EFETIVA_DECOLAGEM
      ,E.SIGLA_IATA_CIA_AEREA AS SIGLA_CIA_AEREA_IATA_PARTIDA
      ,E.NME_CIA_AEREA AS NME_CIA_AEREA_PARTIDA
      ,E.MATRICULA_AERONAVE AS MATRICULA_AERONAVE_PARTIDA    
      ,E.SIGLA_EQUIPAMENTO AS SIGLA_EQUIPAMENTO_PARTIDA
      ,E.NME_EQUIPAMENTO AS NME_EQUIPAMENTO_PARTIDA
      ,E.SIGLA_AEROPORTO_DES
      ,E.DSC_PISTA_DEC AS PISTA_DECOLAGEM
      ,NULL AS DATA_HORA_MOV_EP
      ,NULL AS BOX_EP
      ,NULL AS TIPO_BOX_EP
      ,NULL AS TPS_EP
      ,4 AS ORDEM
  FROM  BIOGER_RPE_DES AS D
     ,  BIOGER_RPE_EMB AS E
 WHERE  D.CD_STA = E.CD_STA
   AND  D.SIGLA_AEROPORTO = E.SIGLA_AEROPORTO
   AND  D.SIGLA_AEROPORTO = @SIGLA_AEROPORTO
   AND  YEAR(D.DATA_HORA_EFETIVA_POUSO) = @ANO
   AND	MONTH(D.DATA_HORA_EFETIVA_POUSO) = @MES
   --AND  DAY(D.DATA_HORA_EFETIVA_POUSO) = @DIA
   AND  D.GRUPO_VOO = 1

INSERT INTO @TMP
SELECT D.CD_STA
      ,D.SIGLA_AEROPORTO
      ,D.NUMERO_VOO
      ,D.GRUPO_VOO
      ,D.NATUREZA_VOO
      ,D.CLASSE_VOO
      ,D.CATEGORIA_VOO
      ,D.CATEGORIA_VOO_VINCULADO
      ,'EP' AS TIPO_MOV_DE
      ,NULL AS DATA_HORA_NORMAL_DECOLAGEM
      ,NULL AS DATA_HORA_EFETIVA_DECOLAGEM
      ,NULL AS SIGLA_CIA_AEREA_IATA_PARTIDA
      ,NULL AS NME_CIA_AEREA_PARTIDA
      ,NULL AS MATRICULA_AERONAVE_PARTIDA    
      ,NULL AS SIGLA_EQUIPAMENTO_PARTIDA
      ,NULL AS NME_EQUIPAMENTO_PARTIDA
      ,NULL AS SIGLA_AEROPORTO_DES
      ,NULL AS PISTA_DECOLAGEM
      ,NULL AS DATA_HORA_MOV_EP
      ,NULL AS BOX_EP
      ,NULL AS TIPO_BOX_EP
      ,NULL AS TPS_EP
      , 2 AS ORDEM
  FROM  BIOGER_RPE_DES AS D
     ,  BIOGER_RPE_EMB AS E
 WHERE  D.CD_STA = E.CD_STA
   AND  D.SIGLA_AEROPORTO = E.SIGLA_AEROPORTO
   AND  D.SIGLA_AEROPORTO = @SIGLA_AEROPORTO
   AND  YEAR(D.DATA_HORA_EFETIVA_POUSO) = @ANO
   AND	MONTH(D.DATA_HORA_EFETIVA_POUSO) = @MES
   --AND  DAY(D.DATA_HORA_EFETIVA_POUSO) = @DIA
   AND  D.GRUPO_VOO = 1

INSERT INTO @TMP
SELECT D.CD_STA
      ,D.SIGLA_AEROPORTO
      ,D.NUMERO_VOO
      ,D.GRUPO_VOO
      ,D.NATUREZA_VOO
      ,D.CLASSE_VOO
      ,D.CATEGORIA_VOO
      ,D.CATEGORIA_VOO_VINCULADO
      ,'SP' AS TIPO_MOV_DE
      ,NULL AS DATA_HORA_NORMAL_DECOLAGEM
      ,NULL AS DATA_HORA_EFETIVA_DECOLAGEM
      ,NULL AS SIGLA_CIA_AEREA_IATA_PARTIDA
      ,NULL AS NME_CIA_AEREA_PARTIDA
      ,NULL AS MATRICULA_AERONAVE_PARTIDA    
      ,NULL AS SIGLA_EQUIPAMENTO_PARTIDA
      ,NULL AS NME_EQUIPAMENTO_PARTIDA
      ,NULL AS SIGLA_AEROPORTO_DES
      ,NULL AS PISTA_DECOLAGEM
      ,NULL AS DATA_HORA_MOV_EP
      ,NULL AS BOX_EP
      ,NULL AS TIPO_BOX_EP
      ,NULL AS TPS_EP
      ,3 AS ORDEM
  FROM  BIOGER_RPE_DES AS D
     ,  BIOGER_RPE_EMB AS E
 WHERE  D.CD_STA = E.CD_STA
   AND  D.SIGLA_AEROPORTO = E.SIGLA_AEROPORTO
   AND  D.SIGLA_AEROPORTO = @SIGLA_AEROPORTO
   AND  YEAR(D.DATA_HORA_EFETIVA_POUSO) = @ANO
   AND	MONTH(D.DATA_HORA_EFETIVA_POUSO) = @MES
   --AND  DAY(D.DATA_HORA_EFETIVA_POUSO) = @DIA
   AND  D.GRUPO_VOO = 1

DECLARE
		@STA INT
       ,@AEROPORTO VARCHAR(4)
       ,@TIPO_MOV VARCHAR(4)
       ,@DATA_HORA_MOV DATETIME
       ,@NR_BOX VARCHAR(4)
       ,@TP_BOX VARCHAR(4)
       ,@NR_TPS VARCHAR(4)

DECLARE C_MOV CURSOR FOR
SELECT 	DISTINCT
        CD_STA
       ,SIGLA_AEROPORTO
FROM   @TMP

OPEN C_MOV
FETCH NEXT FROM C_MOV 
INTO @STA
,    @AEROPORTO


WHILE @@FETCH_STATUS = 0
BEGIN

        DECLARE C_MOV_EP CURSOR FOR
		SELECT TIPO_MOV
			  ,DATA_HORA_MOV
			  ,NR_BOX
			  ,TP_BOX
			  ,NR_TPS
        FROM  BIOGER_RPE_MOV
        WHERE CD_STA = @STA
          AND SIGLA_AEROPORTO = @AEROPORTO
          AND TIPO_MOV = 'EP'
        ORDER BY DATA_HORA_MOV

	    OPEN C_MOV_EP
		FETCH NEXT FROM C_MOV_EP 
		INTO   @TIPO_MOV
			  ,@DATA_HORA_MOV
			  ,@NR_BOX
			  ,@TP_BOX
			  ,@NR_TPS
   
        WHILE @@FETCH_STATUS = 0
        BEGIN

			UPDATE @TMP
			SET    DATA_HORA_MOV_EP_SP = @DATA_HORA_MOV
				  ,BOX_EP = @NR_BOX
				  ,TIPO_BOX_EP = @TP_BOX
				  ,TPS_EP = @NR_TPS
           WHERE CD_STA = @STA
             AND SIGLA_AEROPORTO = @AEROPORTO
             AND TIPO_MOV = 'EP'

           BREAK 

        END

		CLOSE C_MOV_EP
		DEALLOCATE C_MOV_EP


		DECLARE C_MOV_SP CURSOR FOR
		SELECT TIPO_MOV
			  ,DATA_HORA_MOV
        FROM  BIOGER_RPE_MOV
        WHERE CD_STA = @STA
          AND SIGLA_AEROPORTO = @AEROPORTO
          AND TIPO_MOV = 'SP'
        ORDER BY DATA_HORA_MOV DESC

	    OPEN C_MOV_SP
		FETCH NEXT FROM C_MOV_SP 
		INTO   @TIPO_MOV
			  ,@DATA_HORA_MOV

   
        WHILE @@FETCH_STATUS = 0
        BEGIN

			UPDATE @TMP
			SET   DATA_HORA_MOV_EP_SP = @DATA_HORA_MOV
           WHERE CD_STA = @STA
             AND SIGLA_AEROPORTO = @AEROPORTO
			 AND TIPO_MOV = 'SP'

           BREAK 

        END

		CLOSE C_MOV_SP
		DEALLOCATE C_MOV_SP

		FETCH NEXT FROM C_MOV 
		INTO @STA
		,    @AEROPORTO

END

CLOSE C_MOV
DEALLOCATE C_MOV

SELECT *
FROM @TMP
 ORDER
    BY  NUMERO_VOO,ORDEM
      

