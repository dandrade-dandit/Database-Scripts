SET SCAN OFF
CREATE OR REPLACE PACKAGE FUNCOES_ABSENTEISMO AS  
  TYPE TCADORG is RECORD (
         CODIGO  NUMBER,
         TOTAL NUMBER);
  TYPE TDADOS IS REF CURSOR RETURN TCADORG;
  TYPE TDEMONSTRATIVO is RECORD (
         CODIGO  NUMBER,
         TOTAL NUMBER,
         MATRICULA NUMBER,
         LOTACAO NUMBER,
         NOME VARCHAR2(50));
  TYPE TDEMO IS REF CURSOR RETURN TDEMONSTRATIVO;
  	PROCEDURE OCORRENCIAS_COORDENADORIA(TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2,SANO IN VARCHAR2);

  	PROCEDURE OCORRENCIAS_GERENCIA (TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2,SANO IN VARCHAR2);

  	PROCEDURE FREQUENCIA_COORDENADORIA(TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2,SANO IN VARCHAR2);

  	PROCEDURE FREQUENCIA_GERENCIA (TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2,SANO IN VARCHAR2);

        PROCEDURE DEMONSTRATIVO_FALTAS(TAB IN OUT TDEMO , IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2,SANO IN VARCHAR2, SMES1 IN VARCHAR2, SANO1 IN VARCHAR2);

	PROCEDURE DEMONSTRATIVO_FALTAS_GERENCIA (TAB IN OUT TDEMO , IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2,SANO IN VARCHAR2, SMES1 IN VARCHAR2, SANO1 IN VARCHAR2);

	PROCEDURE TOT_OCO_AC_FA_FN_COORDENADORIA(TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SANO IN VARCHAR2);

	PROCEDURE TOT_OCO_AC_FA_FN_GERENCIA(TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SANO IN VARCHAR2);

	
END FUNCOES_ABSENTEISMO;
/
CREATE OR REPLACE PACKAGE BODY FUNCOES_ABSENTEISMO AS
  
/*Retorna o total por ocorrência da coordenadoria escolhida*/

PROCEDURE OCORRENCIAS_COORDENADORIA(TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2, SANO IN VARCHAR2) IS     
  BEGIN
     OPEN TAB FOR 
     SELECT CODIGO, COUNT(*) AS TOTAL FROM (
       SELECT F.OFE_OFU_CODIGO AS CODIGO
       FROM CADASTROS C, OCORRENCIAS_FREQUENCIA_EMP F 
       WHERE C.EMP_UOR_CODIGO_LOTACAO = IUOR_CODIGO
       AND F.OFE_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA
       AND C.EMP_STATUS <> '2'
       AND F.OFE_OFU_CODIGO  IN (46,49,32,29,23,24,224,225,226,227,228,229,230,231,232,13,50,60,48,47,124,51,75,35,151,162,34,61,28,156,54,25)
       AND EXTRACT(MONTH FROM F.OFE_DATA_INICIO) = SMES
       AND EXTRACT(YEAR FROM F.OFE_DATA_INICIO) = SANO
       UNION ALL
       SELECT O.OEM_OFU_CODIGO AS CODIGO
       FROM CADASTROS C , OCORRENCIAS_EMPREGADOS O
       where C.EMP_STATUS <> '2'
       AND C.EMP_UOR_CODIGO_LOTACAO = IUOR_CODIGO
       AND O.OEM_OFU_CODIGO IN (46,49,32,29,23,24,224,225,226,227,228,229,230,231,232,13,50,60,48,47,124,51,75,35,151,162,34,61,28,156,54,25)
       AND O.OEM_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA 
       AND EXTRACT(MONTH FROM O.OEM_DATA_INICIO) = SMES
       AND EXTRACT(YEAR FROM O.OEM_DATA_INICIO) = SANO
     ) GROUP BY CODIGO;
  END;


/*Retorna o total por ocorrência da gerência escolhida, e as coordenadorias subordinadas a ela*/

  PROCEDURE OCORRENCIAS_GERENCIA(TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2, SANO IN VARCHAR2 ) IS     
  BEGIN
     OPEN TAB FOR 
     SELECT CODIGO, COUNT(*) AS TOTAL FROM (
       SELECT F.OFE_OFU_CODIGO AS CODIGO
       FROM CADASTROS C, OCORRENCIAS_FREQUENCIA_EMP F 
       WHERE F.OFE_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA
       AND C.EMP_STATUS <> '2'
       AND F.OFE_OFU_CODIGO  IN (46,49,32,29,23,24,224,225,226,227,228,229,230,231,232,13,50,60,48,47,124,51,75,35,151,162,34,61,28,156,54,25)
       AND EXTRACT(MONTH FROM F.OFE_DATA_INICIO) = SMES
       AND EXTRACT(YEAR FROM F.OFE_DATA_INICIO) = SANO
       AND C.EMP_UOR_CODIGO_LOTACAO in (SELECT UOR_CODIGO FROM UNIDADES_ORGANIZACIONAIS WHERE UOR_UOR_CODIGO = IUOR_CODIGO OR UOR_CODIGO = IUOR_CODIGO)
       UNION ALL
       SELECT O.OEM_OFU_CODIGO AS CODIGO
       FROM CADASTROS C , OCORRENCIAS_EMPREGADOS O
       WHERE C.EMP_STATUS <> '2'
       AND O.OEM_OFU_CODIGO IN (46,49,32,29,23,24,224,225,226,227,228,229,230,231,232,13,50,60,48,47,124,51,75,35,151,162,34,61,28,156,54,25)
       AND O.OEM_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA 
       AND EXTRACT(MONTH FROM O.OEM_DATA_INICIO) = smes
       AND EXTRACT(YEAR FROM O.OEM_DATA_INICIO) = sano
       AND C.EMP_UOR_CODIGO_LOTACAO in (SELECT UOR_CODIGO FROM UNIDADES_ORGANIZACIONAIS WHERE UOR_UOR_CODIGO = IUOR_CODIGO OR UOR_CODIGO = IUOR_CODIGO)
     ) GROUP BY CODIGO;
  END;

/*Retorna o total por ocorrência de frequencia da coordenadoria escolhida */

 PROCEDURE FREQUENCIA_COORDENADORIA(TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2, SANO IN VARCHAR2) IS     
  BEGIN
     OPEN TAB FOR 
     SELECT CODIGO, COUNT(*) AS TOTAL FROM (
       SELECT F.OFE_OFU_CODIGO AS CODIGO
       FROM CADASTROS C, OCORRENCIAS_FREQUENCIA_EMP F 
       WHERE C.EMP_UOR_CODIGO_LOTACAO = IUOR_CODIGO
       AND F.OFE_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA
       AND C.EMP_STATUS <> '2'
       AND F.OFE_OFU_CODIGO  IN (37,187,188,38,167,39,40,42,41,43,65,66,67)
       AND EXTRACT(MONTH FROM F.OFE_DATA_INICIO) = SMES
       AND EXTRACT(YEAR FROM F.OFE_DATA_INICIO) = SANO
       UNION ALL
       SELECT O.OEM_OFU_CODIGO AS CODIGO
       FROM CADASTROS C , OCORRENCIAS_EMPREGADOS O
       where C.EMP_STATUS <> '2'
       AND C.EMP_UOR_CODIGO_LOTACAO = IUOR_CODIGO
       AND O.OEM_OFU_CODIGO IN (37,187,188,38,167,39,40,42,41,43,65,66,67)
       AND O.OEM_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA 
       AND EXTRACT(MONTH FROM O.OEM_DATA_INICIO) = SMES
       AND EXTRACT(YEAR FROM O.OEM_DATA_INICIO) = SANO
     ) GROUP BY CODIGO;
  END;

/*Retorna o total por ocorrência de frequencia da gerência escolhida, e as coordenadorias subordinadas a ela*/

  PROCEDURE FREQUENCIA_GERENCIA(TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2, SANO IN VARCHAR2 ) IS     
  BEGIN
     OPEN TAB FOR 
     SELECT CODIGO, COUNT(*) AS TOTAL FROM (
       SELECT F.OFE_OFU_CODIGO AS CODIGO
       FROM CADASTROS C, OCORRENCIAS_FREQUENCIA_EMP F 
       WHERE F.OFE_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA
       AND C.EMP_STATUS <> '2'
       AND F.OFE_OFU_CODIGO  IN (37,187,188,38,167,39,40,42,41,43,65,66,67)
       AND EXTRACT(MONTH FROM F.OFE_DATA_INICIO) = SMES
       AND EXTRACT(YEAR FROM F.OFE_DATA_INICIO) = SANO
       AND C.EMP_UOR_CODIGO_LOTACAO in (SELECT UOR_CODIGO FROM UNIDADES_ORGANIZACIONAIS WHERE UOR_UOR_CODIGO = IUOR_CODIGO OR UOR_CODIGO = IUOR_CODIGO)
       UNION ALL
       SELECT O.OEM_OFU_CODIGO AS CODIGO
       FROM CADASTROS C , OCORRENCIAS_EMPREGADOS O
       WHERE C.EMP_STATUS <> '2'
       AND O.OEM_OFU_CODIGO IN (37,187,188,38,167,39,40,42,41,43,65,66,67)
       AND O.OEM_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA 
       AND EXTRACT(MONTH FROM O.OEM_DATA_INICIO) = SMES
       AND EXTRACT(YEAR FROM O.OEM_DATA_INICIO) = SANO
       AND C.EMP_UOR_CODIGO_LOTACAO in (SELECT UOR_CODIGO FROM UNIDADES_ORGANIZACIONAIS WHERE UOR_UOR_CODIGO = IUOR_CODIGO OR UOR_CODIGO = IUOR_CODIGO)
     ) GROUP BY CODIGO;
  END;

/*Retorna o total de ocorrências por : matrícula , lotação e nome da coordenadoria escolhida */

PROCEDURE DEMONSTRATIVO_FALTAS(TAB IN OUT TDEMO , IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2, SANO IN VARCHAR2, SMES1 IN VARCHAR2, SANO1 IN VARCHAR2) IS     
  BEGIN
     OPEN TAB FOR 
     SELECT CODIGO, COUNT(*) AS TOTAL , MATRICULA, LOTACAO, NOME FROM (
       SELECT F.OFE_OFU_CODIGO AS CODIGO, c.emp_numero_matricula AS MATRICULA,c.emp_uor_codigo_lotacao as LOTACAO,c.emp_nome_abreviado NOME
       FROM CADASTROS C, OCORRENCIAS_FREQUENCIA_EMP F 
       WHERE C.EMP_UOR_CODIGO_LOTACAO = IUOR_CODIGO
       AND F.OFE_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA
       AND C.EMP_STATUS <> '2'
       AND F.OFE_OFU_CODIGO  IN (49, 32, 50, 60, 48, 47, 23, 24, 224, 225, 226, 227, 228, 229, 230, 231, 232, 51, 75, 35, 34, 61)
       AND EXTRACT(MONTH FROM f.OFE_DATA_INICIO) between SMES and SMES1
       AND EXTRACT(YEAR FROM f.OFE_DATA_INICIO) between SANO and SANO1
       UNION ALL
       SELECT O.OEM_OFU_CODIGO AS CODIGO, c.emp_numero_matricula AS MATRICULA,c.emp_uor_codigo_lotacao as LOTACAO,c.emp_nome_abreviado NOME
       FROM CADASTROS C , OCORRENCIAS_EMPREGADOS O
       where C.EMP_STATUS <> '2'
       AND C.EMP_UOR_CODIGO_LOTACAO = IUOR_CODIGO
       AND O.OEM_OFU_CODIGO IN (49, 32, 50, 60, 48, 47, 23, 24, 224, 225, 226, 227, 228, 229, 230, 231, 232, 51, 75, 35, 34, 61)
       AND O.OEM_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA 
       AND EXTRACT(MONTH FROM o.OEM_DATA_INICIO) between SMES and SMES1
       AND EXTRACT(YEAR FROM o.OEM_DATA_INICIO) between SANO and SANO1
     ) GROUP BY CODIGO,MATRICULA,LOTACAO, NOME
     ORDER BY LOTACAO, NOME;
  END;

/*Retorna o total de ocorrências por : matrícula , lotação e nome da gerência escolhida, e das coordenadorias subordinadas a ela*/

PROCEDURE DEMONSTRATIVO_FALTAS_GERENCIA(TAB IN OUT TDEMO , IUOR_CODIGO IN NUMBER, SMES IN VARCHAR2, SANO IN VARCHAR2, SMES1 IN VARCHAR2, SANO1 IN VARCHAR2) IS     
  BEGIN
     OPEN TAB FOR 
     SELECT CODIGO, COUNT(*) AS TOTAL , MATRICULA, LOTACAO, NOME FROM (
       SELECT F.OFE_OFU_CODIGO AS CODIGO, c.emp_numero_matricula AS MATRICULA,c.emp_uor_codigo_lotacao as LOTACAO,c.emp_nome_abreviado NOME
       FROM CADASTROS C, OCORRENCIAS_FREQUENCIA_EMP F 
       WHERE F.OFE_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA
       AND C.EMP_STATUS <> '2'
       AND F.OFE_OFU_CODIGO  IN (49, 32, 50, 60, 48, 47, 23, 24, 224, 225, 226, 227, 228, 229, 230, 231, 232, 51, 75, 35, 34, 61)
       AND EXTRACT(MONTH FROM f.OFE_DATA_INICIO) between SMES and SMES1
       AND EXTRACT(YEAR FROM f.OFE_DATA_INICIO) between SANO and SANO1
AND C.EMP_UOR_CODIGO_LOTACAO in (SELECT UOR_CODIGO FROM UNIDADES_ORGANIZACIONAIS WHERE UOR_UOR_CODIGO = IUOR_CODIGO OR UOR_CODIGO = IUOR_CODIGO)
       UNION ALL
       SELECT O.OEM_OFU_CODIGO AS CODIGO, c.emp_numero_matricula AS MATRICULA,c.emp_uor_codigo_lotacao as LOTACAO,c.emp_nome_abreviado NOME
       FROM CADASTROS C , OCORRENCIAS_EMPREGADOS O
       where C.EMP_STATUS <> '2'
       AND O.OEM_OFU_CODIGO IN (49, 32, 50, 60, 48, 47, 23, 24, 224, 225, 226, 227, 228, 229, 230, 231, 232, 51, 75, 35, 34, 61)
       AND O.OEM_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA 
       AND EXTRACT(MONTH FROM o.OEM_DATA_INICIO) between SMES and SMES1
       AND EXTRACT(YEAR FROM o.OEM_DATA_INICIO) between SANO and SANO1
       AND C.EMP_UOR_CODIGO_LOTACAO in (SELECT UOR_CODIGO FROM UNIDADES_ORGANIZACIONAIS WHERE UOR_UOR_CODIGO = IUOR_CODIGO OR UOR_CODIGO = IUOR_CODIGO)
     ) GROUP BY CODIGO,MATRICULA,LOTACAO, NOME
     ORDER BY LOTACAO, NOME;
END;

PROCEDURE TOT_OCO_AC_FA_FN_GERENCIA(TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SANO IN VARCHAR2 ) IS     
  BEGIN
     OPEN TAB FOR 
     SELECT CODIGO, COUNT(*) AS TOTAL FROM (
       SELECT F.OFE_OFU_CODIGO AS CODIGO
       FROM CADASTROS C, OCORRENCIAS_FREQUENCIA_EMP F 
       WHERE F.OFE_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA
       AND C.EMP_STATUS <> '2'
       AND F.OFE_OFU_CODIGO  IN (50,34,51)
       AND EXTRACT(YEAR FROM F.OFE_DATA_INICIO) = SANO
       AND C.EMP_UOR_CODIGO_LOTACAO in (SELECT UOR_CODIGO FROM UNIDADES_ORGANIZACIONAIS WHERE UOR_UOR_CODIGO = IUOR_CODIGO OR UOR_CODIGO = IUOR_CODIGO)
       UNION ALL
       SELECT O.OEM_OFU_CODIGO AS CODIGO
       FROM CADASTROS C , OCORRENCIAS_EMPREGADOS O
       WHERE C.EMP_STATUS <> '2'
       AND O.OEM_OFU_CODIGO IN (50,34,51)
       AND O.OEM_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA 
       AND EXTRACT(YEAR FROM O.OEM_DATA_INICIO) = SANO
       AND C.EMP_UOR_CODIGO_LOTACAO in (SELECT UOR_CODIGO FROM UNIDADES_ORGANIZACIONAIS WHERE UOR_UOR_CODIGO = IUOR_CODIGO OR UOR_CODIGO = IUOR_CODIGO)
     ) GROUP BY CODIGO;
  END;

PROCEDURE TOT_OCO_AC_FA_FN_COORDENADORIA(TAB IN OUT TDADOS, IUOR_CODIGO IN NUMBER, SANO IN VARCHAR2) IS     
  BEGIN
     OPEN TAB FOR 
     SELECT CODIGO, COUNT(*) AS TOTAL FROM (
       SELECT F.OFE_OFU_CODIGO AS CODIGO
       FROM CADASTROS C, OCORRENCIAS_FREQUENCIA_EMP F 
       WHERE C.EMP_UOR_CODIGO_LOTACAO = IUOR_CODIGO
       AND F.OFE_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA
       AND C.EMP_STATUS <> '2'
       AND F.OFE_OFU_CODIGO  IN (50,34,51)
       AND EXTRACT(YEAR FROM F.OFE_DATA_INICIO) = SANO
       UNION ALL
       SELECT O.OEM_OFU_CODIGO AS CODIGO
       FROM CADASTROS C , OCORRENCIAS_EMPREGADOS O
       where C.EMP_STATUS <> '2'
       AND C.EMP_UOR_CODIGO_LOTACAO = IUOR_CODIGO
       AND O.OEM_OFU_CODIGO IN (50,34,51)
       AND O.OEM_EMP_NUMERO_MATRICULA = C.EMP_NUMERO_MATRICULA 
       AND EXTRACT(YEAR FROM O.OEM_DATA_INICIO) = SANO
     ) GROUP BY CODIGO;
  END;


END FUNCOES_ABSENTEISMO;
/
SHOW ERROR